---
title: "Florida 2016 Presidential Campaign Contributions (as of October 2016)"
author: "Marty VanHoof"
output:
  html_document:
    #code_folding: hide
    keep_md: true
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: 2
---

This report is an exploratory data analysis of campaign finance data from the Florida 2016 presidential primary elections.  A description of the different columns in the dataset is [here](https://www.dropbox.com/s/2fc15css7bp0jgq/CONTRIBUTOR_FORMAT.txt?dl=0).  I originally completed this analysis about a month before the November 2016 election. If I was doing the analysis retrospectively, then it would probably be different.  

```{r packages, message=FALSE, warning=FALSE}
### load required packages
#install.packages("genderdata", repos = "http://packages.ropensci.org", type = #"source")

library(ggplot2)
library(dplyr)
library(knitr)
library(tidyr)
library(gender)
library(gridExtra)
```

## 1. Initial Data Wrangling

In my local folder I renamed the dataset to `FL_contributions.csv`.  There is a problem with loading the dataset directly, since the row names are not unique.  To get around this, set `row.names = Null`, which reads in the first column of the dataset as a column of data rather than row names.  This will assign the first column the column name `row.names` and shift all the other column names over by one, so that now the column names are no longer associcated with the correct columns.  We can fix this by first moving all the columns over one place (assigning `x` as a name for the last column), and then finally removing this last column.  

Also, there are a bunch of columns in the dataset that are not needed:

`cand_id, memo_cd, form_tp, file_num, tran_id, contbr_st`. 

I'm just going to remove these columns.

```{r}
### load the data
fl = read.csv('FL_contributions.csv', row.names = NULL)
colnames(fl) = c(colnames(fl)[-1], "x")
fl$x = NULL

### remove the columns that we don't need
fl = subset(fl, select = -c(cand_id, memo_cd, form_tp, file_num, tran_id, contbr_st))
```

I want to create 2 more categorical variables for my analysis:  Gender and political party affiliation.  To create the variable for gender, we first split the ` contbr_nm` column into 2 new columns `FirstName` and `LastName`:

```{r}
### Create a copy of the 'fl' dataframe
fl.1 = fl

### create a new column where the names are character types rather than factors
fl.1$contbr_nm.new = as.character(fl.1$contbr_nm)

### Extract the lastname and firstname from the 'contbr_nm.new' column.  
### Create 2 new columns in the dataframe:  'LastName', 'FirstName'
fl.1 = extract(fl.1, contbr_nm.new, c('LastName', 'FirstName'), '(.*),\\s*(\\S*)\\s*.*', fill = 'left', perl = TRUE)
```

We will now use the `gender()` function in R to predict gender based on a person's firstname.

```{r}
### Use gender() function to predict gender, then merge the columns with 'fl.1'
names_gender = gender(unique(fl.1$FirstName), method = "ssa" )
names_gender = names_gender[ , c('name', 'gender')]
fl.1 = merge(fl.1, names_gender, by.x = 'FirstName', by.y = 'name', all.x = TRUE)

### Drop 'FirstName' and 'LastName' columns from the dataset and make 'gender' into a factor variable
fl.1 = subset(fl.1, select = -c(FirstName, LastName))
fl.1$gender = factor(fl.1$gender)
```

Note that there are 9605 names where the `gender()` function returned NA:

```{r}
nrow(subset(fl.1, is.na(gender)))
```

So when we do any analysis using gender, we'll have to remember to exclude those rows from the dataset.  

Now let's create a variable for political party affiliation of the campaign contributor.  We will make the assumption that the contributor is affiliated with the same party as the candidate they donated to.

```{r}
### Create a variable for political party
democrat = c('Sanders, Bernard', 'Lessig, Lawrence', 'Clinton, Hillary Rodham',
              "O'Malley, Martin Joseph", 'Webb, James Henry Jr.')
libertarian = 'Johnson, Gary'
green = 'Stein, Jill'
other = 'McMullin, Evan'
all_cands = unique(fl.1$cand_nm)
republican = all_cands[ !(all_cands %in% c(democrat, libertarian, green, other))]

fl.1$party = with(fl.1, ifelse(cand_nm %in% democrat, 'Democrat',
                        ifelse(cand_nm %in% libertarian, 'Libertarian',
                        ifelse(cand_nm %in% green, 'Green',
                        ifelse(cand_nm %in% other, 'Other', 'Republican')))))

### Make 'party' into a factor variable
fl.1$party = factor(fl.1$party)
```

The column `contb_receipt_dt` is currently a factor variable.  Let's convert the column to date format so that we can eventually look at time series plots.

```{r}
fl.1$contb_receipt_dt = as.Date(fl.1$contb_receipt_dt, "%d-%b-%y")
```

Now we are ready to start the exploratory data analysis.

## 2. Univariate Analysis

Let's start by looking at some summaries of the dataset.  Here are the column variables in our dataset.  There are 14 of them.

```{r echo=FALSE, Univariate_Plots_1}
names(fl.1)
```

The median contribution amount for all candidates is 28.42 and the mean contribution amount is 145.97.

```{r echo=FALSE, Univariate_Plots_2}
summary(fl.1$contb_receipt_amt)
```

This suggests that the distribution of ` contb_receipt_amt` is right-skewed (and we will investigate this with some plots).  There are also negative contribution amounts which are probably refunds.

The candidate with the most individual contributions is Hillary Clinton (128353).

```{r echo=FALSE, Univariate_Plots_3}
table(fl.1$cand_nm)
```

The Democrat Party has the highest number of contributions with 211105, and the Republican Party has the 2nd highest number of contributions with 125319.

```{r echo=FALSE, Univariate_Plots_3.1}
table(fl.1$party)
```

Now we'll start some data visualization and look at the distribution of contribution amounts, omitting the negative contributions.

```{r echo=FALSE, Univariate_Plots_4}
pos_contb = subset(fl.1, contb_receipt_amt > 0)
ggplot(aes(x = contb_receipt_amt), data = pos_contb) +
  geom_histogram(binwidth = 50) 
```

As I suspected, the data is highly skewed.  The vast majority of contributions are in the smaller range, but it's really hard to see from the graph.  Let's find the 99th percentile of all contribution amounts and then limit the x-axis at this value. The 99th percentile is

```{r echo=FALSE, Univariate_Plots_5}
quantile(pos_contb$contb_receipt_amt, 0.99)
```

Now let's look at the histogram again, but with the contribution amounts limited at 2700.  We will also add some more breaks on the x and y axes in order to see the amounts better, and apply a square root transformation to the y-axis, which gives us a better view of the values in the tail of the distribution.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_6}
# Omit the top 1% of contribution amounts and apply the sqrt function to the y-axis
ggplot(aes(x = contb_receipt_amt), data = pos_contb) +
  geom_histogram(binwidth = 50) +
  scale_x_continuous(limits = c(0, 2700), breaks = seq(0, 2700, 200)) +
  scale_y_sqrt(breaks = c(5000,10000,25000,50000,75000,100000)) 
```

This is much better.  We can now see that most of the contributions are $100 or less with some spikes in contributions around $300, $500, $1000, $2000, $2500.  I assume these are people making larger contributions who decided on certain nice rounded numbers to contribute.

We can plot the x values on a log10 scale in order to see the smaller contribution amounts better.  It appears that the log-transformed plot is somewhat symmetric, maybe approximately normal.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_7}
ggplot(aes(x = contb_receipt_amt), data = pos_contb) +
  geom_histogram(binwidth = 0.175) +
  scale_x_log10(breaks = c(10,25,100,500,2500,10000))
```

From this plot we can easily see that a large chunk of the contributions are $100 or less, and that the mode is $25.  In fact, $100 is the 75th percentile of individual contribution amounts, so 75% of the contributions are $100 or less.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_8}
quantile(pos_contb$contb_receipt_amt, 0.75)
```

I'm curious how the above distributions look when separated by gender. Are there any differences in the distributions for male versus female? 

```{r echo=FALSE, warning = FALSE, Univariate_Plots_9}
# Add a layer to the above plots to facet by gender
ggplot(aes(x = contb_receipt_amt), data = subset(pos_contb, !is.na(gender))) +
  geom_histogram(binwidth = 50) +
  scale_x_continuous(limits = c(0, 2700)) +
  scale_y_sqrt(breaks = c(5000,10000,25000,50000,75000,100000)) +
  facet_wrap(~gender)

ggplot(aes(x = contb_receipt_amt), data = subset(pos_contb, !is.na(gender))) +
  geom_histogram(binwidth = 0.175) +
  scale_x_log10(breaks = c(10,25,100,500,2500,10000)) +
  facet_wrap(~gender)
```

Okay, so it appears that the distributions are quite similar across gender, although if we summarize the contribution amounts by gender, we can see that males contribute a bit more on average.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_10}
by(pos_contb$contb_receipt_amt, pos_contb$gender, summary)
```

How do the number of contributions change with respect to date? To visualize this we can look at a density plot of the variable `contb_receipt_dt` with the counts on the y-axis.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_11}
# Density plot for contb_receipt date
ggplot(data = pos_contb, aes(x = contb_receipt_dt, y = ..count..)) +
  geom_density()
```

The election year in question is 2016, and this plot shows that the number of contributions increase steadily as we get closer to the election.  There are also some spikes and dips in the plot.  I want to dig deeper into 2016 and see how the contributions change from month-to-month.

```{r echo=FALSE, warning = FALSE, Univariate_Plots_11.5}
lims = as.Date(c('2016-01-01', '2016-11-01'))
ggplot(data = pos_contb, aes(x = contb_receipt_dt, y = ..count..)) +
  geom_density() +
  scale_x_date(limits = lims, date_breaks = "2 months")
```

We can see that the number of contributions increases until around March 1 and then starts to decrease again and fluctuate until about mid-May (March 1 2016 was actually Super Tuesday, and I don't know if this is related to the drop-off in contributions or not).  The contributions start to increase sharply again until July 10 or so, and then drop-off and fluctuate a bit after that.  Incidentally, July 12 was the date when Bernie Sanders endorsed Hillary Clinton (again, we don't know if these events are related or not). 

Now let's look at the number of contributions by political party.  

```{r echo=FALSE, warning = FALSE, Univariate_Plots_12}
# Create a table of mean, median, total contributions, and counts grouped by party.
# We will use the other statistics in this table in the bivariate plots section
contb_by_party = pos_contb %>% group_by(party) %>%
  summarise(mean_contb_amt = mean(contb_receipt_amt),
            median_contb_amt = median(contb_receipt_amt),
            total_contb_amt = sum(contb_receipt_amt),
            num_contb = n()) 

# Bar graph for number of contributions by party
ggplot(data = contb_by_party, aes(x = party, y = num_contb)) +
  geom_bar(stat = "identity")

select(contb_by_party, party, num_contb)
```

This graph clearly shows that the number of individual contributions to the 2 major parties (Democrat, Republican) dwarf the other contributions by far.  Also, there are many more individual contributions for Democrats (209044) than Republicans (122125).  We will see later though that the total contribution amount (sum of all contributions) is greater for Republicans than Democrats. 

Let's dig deeper into the contributions and look at the contributions by candidate. Here are the top 10 candidates by number of individual contributions.

```{r echo=FALSE, warning = FALSE, message = FALSE, Univariate_Plots_13}
# Create a table of mean, total contributions, and counts grouped by candidate
contb_by_cand = pos_contb %>% group_by(cand_nm) %>%
  summarise(mean_contb_amt = mean(contb_receipt_amt),
            total_contb_amt = sum(contb_receipt_amt),
            num_contb = n()) %>%
  arrange(desc(num_contb))

# Bar graph of top 10 num_contb by candidate
ggplot(data = contb_by_cand %>% top_n(10), aes(x = reorder(cand_nm, num_contb),
                                               y = num_contb)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  xlab('cand_nm') +
  scale_y_continuous(limits = c(0,130000), breaks = seq(0, 125000, 25000))

select(contb_by_cand %>% top_n(10), cand_nm, num_contb)
```

So we can see that Hillary Clinton has the most individual contributions (126869), followed by Bernie Sanders (81954), Donald Trump (46669), Ted Cruz (28242), etc.

Now let's use a similar bar graph to examine the top 10 occupations by number of contributions.

```{r echo=FALSE, warning = FALSE, message = FALSE, Univariate_Plots_14}
# Create a table of mean, total contributions, and counts grouped by occupation
contb_by_occ = pos_contb %>% group_by(contbr_occupation) %>%
  summarise(mean_contb_amt = mean(contb_receipt_amt),
            median_contb_amt = median(contb_receipt_amt),
            total_contb_amt = sum(contb_receipt_amt),
            num_contb = n()) %>%
  arrange(desc(num_contb))
  
contb_by_occ =
filter(contb_by_occ, contbr_occupation != 'INFORMATION REQUESTED',
         contbr_occupation != 'INFORMATION REQUESTED PER BEST EFFORTS')

# Bar graph of top 10 number of contributions by occupation
ggplot(data = contb_by_occ %>% top_n(10),
       aes(x = reorder(contbr_occupation, num_contb), y = num_contb)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  xlab('contbr_occupation')

select(contb_by_occ %>% top_n(10), contbr_occupation, num_contb)
```

It's interesting to note that retired people make by far the most individual contributions (103328), followed by people who are not employed (31766), then attornies (8055), homemakers (4653), physicians (4647), etc.
